  - name: graphite
    buildsystem: simple
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin:/usr/lib/sdk/node20/bin
      env:
        CARGO_HOME: /run/build/graphite/cargo
        RUSTFLAGS: -C debuginfo=0
        CARGO_NET_GIT_FETCH_WITH_CLI: "true"
        COREPACK_ENABLE_DOWNLOAD_PROMPT: "0"
        NPM_CONFIG_AUDIT: "false"
        NPM_CONFIG_FUND: "false"
    sources:
      - type: git
        url: https://github.com/GraphiteEditor/Graphite.git
        branch: master
    build-commands:
      # Apply Cargo network config to prefer git protocol and CLI
      - mkdir -p .cargo
      - |
        cat > .cargo/config.toml <<'EOF'
        [net]
        git-fetch-with-cli = true

        [registries.crates-io]
        protocol = "git"
        EOF

      # Ensure toolchains
      - . /usr/lib/sdk/rust-stable/enable.sh
      - . /usr/lib/sdk/node20/enable.sh

      # Tools for the web/WASM build
      - cargo install wasm-pack
      - bash -lc 'ver=$(grep -m1 -Po "wasm-bindgen(?:-cli)? = \{[^}]*version *= *\"\\K[^\"]+" Cargo.lock || true); \
                  if [ -n "$ver" ]; then cargo install -f wasm-bindgen-cli --version "$ver"; else cargo install -f wasm-bindgen-cli; fi'

      # Frontend deps
      - cd frontend && corepack enable || true
      - cd frontend && if command -v pnpm >/dev/null 2>&1; then pnpm install --frozen-lockfile; else npm ci; fi

      # Build frontend
      - cd frontend && if command -v pnpm >/dev/null 2>&1; then pnpm run build; else npm run build; fi

      # Build Tauri desktop
      - cd frontend/src-tauri && cargo build --release

      # Install binary
      - |
        set -euo pipefail
        bin="$(find frontend/src-tauri/target/release -maxdepth 1 -type f -executable ! -name '*.so' ! -name '*.*' | head -n1)"
        test -n "${bin:-}" || { echo "Could not locate built binary in target/release"; exit 1; }
        install -Dm755 "$bin" /app/bin/graphite

      # Icons
      - install -Dm644 frontend/src-tauri/icons/128x128.png /app/share/icons/hicolor/128x128/apps/rs.graphite.Graphite.png || true
      - install -Dm644 frontend/src-tauri/icons/256x256.png /app/share/icons/hicolor/256x256/apps/rs.graphite.Graphite.png || true

